<!-- HTML generated using hilite.me -->
<style>
td{
border: 1px solid #BBB;
padding: 4px;
}
</style>
<!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;width:100%; height:100%;"><table><tr><td><pre style="margin: 0; line-height: 125%; color: #999">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #408080; font-style: italic">// Perform Coulomb collisions and calculate the fusion rate for each cell</span>
<span style="color: #408080; font-style: italic">// in the simulation.</span>
<span style="color: #408080; font-style: italic">// Input:  - velocity vectors of all particles in the cell</span>
<span style="color: #408080; font-style: italic">//         - density of particles in cell</span>
<span style="color: #408080; font-style: italic">//         - cell volume</span>
<span style="color: #408080; font-style: italic">//         - max number of collision particles allocated per cell</span>
<span style="color: #408080; font-style: italic">// Result: - New post-collision velocities of particles</span>
<span style="color: #408080; font-style: italic">//         - Fusion rate (in fusion events-per-second)</span>
<span style="color: #408080; font-style: italic">// Author: Andrew M. Chap</span>
<span style="color: #408080; font-style: italic">// Last edited September 2017</span>

<span style="color: #008000; font-weight: bold">__global__</span> <span style="color: #B00040">void</span> <span style="color: #0000FF">performCollisions</span>(
        <span style="color: #B00040">float</span> <span style="color: #666666">*</span>vx, <span style="color: #B00040">float</span> <span style="color: #666666">*</span>vr, <span style="color: #B00040">float</span> <span style="color: #666666">*</span>vt,
        <span style="color: #B00040">int</span> <span style="color: #666666">*</span>Ic,
        <span style="color: #B00040">float</span> <span style="color: #666666">*</span>rho, <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">float</span> <span style="color: #666666">*</span>bmax, <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">float</span> <span style="color: #666666">*</span>CellVolumesPM,
        <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">int</span> maxParticlesPerCell, <span style="color: #B00040">int</span> <span style="color: #666666">*</span>cellResidents,
        <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">int</span> <span style="color: #666666">*</span>cellOccupants, <span style="color: #B00040">int</span> <span style="color: #666666">*</span>cellOccupantsMax,
        <span style="color: #B00040">float</span> <span style="color: #666666">*</span>fusionRate,
        <span style="color: #B00040">float</span> <span style="color: #666666">*</span>partNs, <span style="color: #B00040">float</span> <span style="color: #666666">*</span>partAs,
        curandState <span style="color: #666666">*</span>myCurandstate, 
        <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">float</span> PIdt, <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">float</span> a_coeff,
        <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">int</span> nPM, <span style="color: #008000; font-weight: bold">const</span> <span style="color: #B00040">float</span> L){
    
    <span style="color: #408080; font-style: italic">// Parallelized by cell.  Each process performs all the collisions in</span>
    <span style="color: #408080; font-style: italic">// a cell and then moves on to the next cell</span>
    <span style="color: #B00040">int</span> c <span style="color: #666666">=</span> <span style="color: #008000">threadIdx</span>.x  <span style="color: #666666">+</span> <span style="color: #008000">blockDim</span>.x <span style="color: #666666">*</span> <span style="color: #008000">blockIdx</span>.x;
    
    <span style="color: #408080; font-style: italic">// All Equation numbers and Figure numbers refer to:</span>
    <span style="color: #408080; font-style: italic">// Chap, Andrew M., Sedwick, Raymond J., “Coulomb Collision Model for Use in</span>
    <span style="color: #408080; font-style: italic">// Nonthermal Plasma Simulation”, Phys. Rev. E 95:6 063209 (2017)</span>

    <span style="color: #008000; font-weight: bold">while</span>(c <span style="color: #666666">&lt;</span> nPM){ <span style="color: #408080; font-style: italic">// nPM is number of cells</span>
        <span style="color: #B00040">int</span> np <span style="color: #666666">=</span> cellOccupants[c];
	<span style="color: #408080; font-style: italic">// Just recording the max number of occupants that have been seen in this cell</span>
        <span style="color: #008000; font-weight: bold">if</span>(np <span style="color: #666666">&gt;</span> cellOccupantsMax[c])       
            cellOccupantsMax[c] <span style="color: #666666">=</span> np;
        <span style="color: #408080; font-style: italic">// If we have more particles than the max allocated for, </span>
        <span style="color: #408080; font-style: italic">// we need to truncate our number of particles there</span>
        <span style="color: #B00040">int</span> npTrunc <span style="color: #666666">=</span> np <span style="color: #666666">&lt;=</span> maxParticlesPerCell <span style="color: #666666">?</span> np <span style="color: #666666">:</span> maxParticlesPerCell; 

        <span style="color: #408080; font-style: italic">// Generate random permutation of particles in the cell</span>
        <span style="color: #408080; font-style: italic">// (Fisher Yates algorithm)</span>
        <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #B00040">int</span> p <span style="color: #666666">=</span> npTrunc<span style="color: #666666">-1</span>; p <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>; <span style="color: #666666">--</span>p){
            <span style="color: #408080; font-style: italic">// Generate a random number [0, p-1]</span>
	    <span style="color: #408080; font-style: italic">// curand generates unsigned int random numbers, so we need to convert to int</span>
            <span style="color: #B00040">int</span> r <span style="color: #666666">=</span> (<span style="color: #B00040">int</span>)(curand(<span style="color: #666666">&amp;</span>myCurandstate[c]) <span style="color: #666666">%</span> (((<span style="color: #B00040">unsigned</span> <span style="color: #B00040">int</span>)(p))<span style="color: #666666">+1</span>)); 
            <span style="color: #408080; font-style: italic">// Swap the last element with element at random index</span>
            <span style="color: #B00040">int</span> temp <span style="color: #666666">=</span> cellResidents[c<span style="color: #666666">*</span>maxParticlesPerCell <span style="color: #666666">+</span> p];
            cellResidents[c<span style="color: #666666">*</span>maxParticlesPerCell <span style="color: #666666">+</span> p] <span style="color: #666666">=</span> cellResidents[c<span style="color: #666666">*</span>maxParticlesPerCell <span style="color: #666666">+</span> r];
            cellResidents[c<span style="color: #666666">*</span>maxParticlesPerCell <span style="color: #666666">+</span> r] <span style="color: #666666">=</span> temp;
        }

        <span style="color: #B00040">float</span> fusionRateHere <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>; <span style="color: #408080; font-style: italic">// initialize total fusion rate to zero</span>
	<span style="color: #408080; font-style: italic">// right now we don&#39;t collide the last particle if we have an odd number</span>
        <span style="color: #008000; font-weight: bold">for</span> (<span style="color: #B00040">int</span> p <span style="color: #666666">=</span> <span style="color: #666666">0</span>; p <span style="color: #666666">&lt;</span> npTrunc<span style="color: #666666">-1</span>; p<span style="color: #666666">+=2</span>){ <span style="color: #408080; font-style: italic">// loop through particle pairs</span>
            <span style="color: #408080; font-style: italic">// -------------------------------------------------</span>
            <span style="color: #408080; font-style: italic">// Calculate relative velocity</span>
            <span style="color: #408080; font-style: italic">// -------------------------------------------------</span>
            <span style="color: #408080; font-style: italic">// select particles to be collided</span>
            <span style="color: #B00040">int</span> p1 <span style="color: #666666">=</span> cellResidents[c<span style="color: #666666">*</span>maxParticlesPerCell <span style="color: #666666">+</span> p];
            <span style="color: #B00040">int</span> p2 <span style="color: #666666">=</span> cellResidents[c<span style="color: #666666">*</span>maxParticlesPerCell <span style="color: #666666">+</span> p<span style="color: #666666">+1</span>];
            <span style="color: #408080; font-style: italic">// COM velocity</span>
            <span style="color: #B00040">float</span> VCx <span style="color: #666666">=</span> <span style="color: #666666">0.5f*</span>(vx[p1]<span style="color: #666666">+</span>vx[p2]);
            <span style="color: #B00040">float</span> VCr <span style="color: #666666">=</span> <span style="color: #666666">0.5f*</span>(vr[p1]<span style="color: #666666">+</span>vr[p2]);
            <span style="color: #B00040">float</span> VCt <span style="color: #666666">=</span> <span style="color: #666666">0.5f*</span>(vt[p1]<span style="color: #666666">+</span>vt[p2]);
            <span style="color: #408080; font-style: italic">// Relative velocity of p1 in the COM frame</span>
            <span style="color: #B00040">float</span> VRx <span style="color: #666666">=</span> vx[p1] <span style="color: #666666">-</span> VCx;
            <span style="color: #B00040">float</span> VRr <span style="color: #666666">=</span> vr[p1] <span style="color: #666666">-</span> VCr;
            <span style="color: #B00040">float</span> VRt <span style="color: #666666">=</span> vt[p1] <span style="color: #666666">-</span> VCt;
            <span style="color: #408080; font-style: italic">// Rel velocity squared and magnitude</span>
            <span style="color: #B00040">float</span> VR2 <span style="color: #666666">=</span> VRx<span style="color: #666666">*</span>VRx <span style="color: #666666">+</span> VRr<span style="color: #666666">*</span>VRr <span style="color: #666666">+</span> VRt<span style="color: #666666">*</span>VRt;
            <span style="color: #B00040">float</span> VRm <span style="color: #666666">=</span> sqrtf(VR2);
            <span style="color: #408080; font-style: italic">// The velocity difference</span>
            <span style="color: #B00040">float</span> VDx <span style="color: #666666">=</span> vx[p1] <span style="color: #666666">-</span> vx[p2];
            <span style="color: #B00040">float</span> VDr <span style="color: #666666">=</span> vr[p1] <span style="color: #666666">-</span> vr[p2];
            <span style="color: #B00040">float</span> VDt <span style="color: #666666">=</span> vt[p1] <span style="color: #666666">-</span> vt[p2];
            <span style="color: #408080; font-style: italic">// The velocity difference squared and magnitude</span>
            <span style="color: #B00040">float</span> VD2 <span style="color: #666666">=</span> VDx<span style="color: #666666">*</span>VDx <span style="color: #666666">+</span> VDr<span style="color: #666666">*</span>VDr <span style="color: #666666">+</span> VDt<span style="color: #666666">*</span>VDt;
            <span style="color: #B00040">float</span> VDm <span style="color: #666666">=</span> sqrtf(VD2);
            <span style="color: #B00040">float</span> VD2i <span style="color: #666666">=</span> <span style="color: #666666">1.0f/</span>VD2;

            <span style="color: #408080; font-style: italic">// ------------------------------------</span>
            <span style="color: #408080; font-style: italic">// Calculate fusion rate</span>
            <span style="color: #408080; font-style: italic">// ------------------------------------</span>
            <span style="color: #B00040">float</span> v <span style="color: #666666">=</span> VDm<span style="color: #666666">*</span>SECONDSCONVERSION;
            <span style="color: #B00040">float</span> vInv <span style="color: #666666">=</span> <span style="color: #666666">1.0f/</span>v;
            <span style="color: #B00040">float</span> v2 <span style="color: #666666">=</span> v<span style="color: #666666">*</span>v;
            <span style="color: #B00040">float</span> v4 <span style="color: #666666">=</span> v2<span style="color: #666666">*</span>v2;
            <span style="color: #B00040">float</span> SV;
            <span style="color: #408080; font-style: italic">// fusion cross section calculation from fit functions to experimental data</span>
            <span style="color: #008000; font-weight: bold">if</span> (v <span style="color: #666666">&lt;</span> V400){
                SV <span style="color: #666666">=</span> CV0 <span style="color: #666666">+</span> CV1<span style="color: #666666">*</span>v2 <span style="color: #666666">+</span> CV2<span style="color: #666666">*</span>v4 <span style="color: #666666">+</span> AVL<span style="color: #666666">/</span>((v2<span style="color: #666666">-</span>VS148)<span style="color: #666666">*</span>(v2<span style="color: #666666">-</span>VS148) <span style="color: #666666">+</span> VQ235);
            }<span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">if</span>(v <span style="color: #666666">&lt;</span> V642){
                <span style="color: #B00040">float</span> peak400 <span style="color: #666666">=</span> (v2 <span style="color: #666666">-</span> VS400);
                <span style="color: #B00040">float</span> peak400squared <span style="color: #666666">=</span> peak400<span style="color: #666666">*</span>peak400;
                SV <span style="color: #666666">=</span> DV0 <span style="color: #666666">+</span> 
                     DV1<span style="color: #666666">*</span>peak400 <span style="color: #666666">-</span> 
                     DV2<span style="color: #666666">*</span>peak400<span style="color: #666666">*</span>peak400 <span style="color: #666666">-</span> 
                     DV3<span style="color: #666666">*</span>peak400squared<span style="color: #666666">*</span>peak400squared<span style="color: #666666">*</span>peak400;
            }<span style="color: #008000; font-weight: bold">else</span>{
                SV <span style="color: #666666">=</span> BV0 <span style="color: #666666">+</span> 
                     AV0<span style="color: #666666">/</span>((v2 <span style="color: #666666">-</span> VS5813)<span style="color: #666666">*</span>(v2 <span style="color: #666666">-</span> VS5813) <span style="color: #666666">+</span> VQ857) <span style="color: #666666">+</span>
                     AV1<span style="color: #666666">/</span>((v2 <span style="color: #666666">-</span> VS1083)<span style="color: #666666">*</span>(v2 <span style="color: #666666">-</span> VS1083) <span style="color: #666666">+</span> VQ234) <span style="color: #666666">+</span>
                     AV2<span style="color: #666666">/</span>((v2 <span style="color: #666666">-</span> VS2405)<span style="color: #666666">*</span>(v2 <span style="color: #666666">-</span> VS2405) <span style="color: #666666">+</span> VQ138) <span style="color: #666666">+</span>
                     AV3<span style="color: #666666">/</span>((v2 <span style="color: #666666">-</span> VS3344)<span style="color: #666666">*</span>(v2 <span style="color: #666666">-</span> VS3344) <span style="color: #666666">+</span> VQ309);
            }
            <span style="color: #408080; font-style: italic">// Density squared multiplied by volume (Have to divide rho by volume to get</span>
            <span style="color: #408080; font-style: italic">// Density, so in this case we just divide once by volume)</span>
            <span style="color: #B00040">float</span> fusionContribution <span style="color: #666666">=</span> rho[c]<span style="color: #666666">*</span>rho[c]<span style="color: #666666">/</span>(CellVolumesPM[c]<span style="color: #666666">*</span>L<span style="color: #666666">*</span>L<span style="color: #666666">*</span>L) <span style="color: #666666">*</span> 
                    vInv<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>VG<span style="color: #666666">*</span>vInv)<span style="color: #666666">*</span>(<span style="color: #666666">1.0f/</span>SECONDSCONVERSION)<span style="color: #666666">*</span>SV<span style="color: #666666">/4.0f/</span>(<span style="color: #B00040">float</span>(npTrunc));
            <span style="color: #408080; font-style: italic">// Above is Eq. (4.18) from my PhD thesis (not in Coulomb paper)</span>
            <span style="color: #408080; font-style: italic">// Later (in MATLAB plotting) it gets multiplied by dE (8.7e6 MeV)</span>
            <span style="color: #408080; font-style: italic">// i.e. Eq. (4.19) in PhD thesis</span>
           
            <span style="color: #008000; font-weight: bold">if</span> (fusionContribution <span style="color: #666666">!=</span> fusionContribution){ <span style="color: #408080; font-style: italic">//if nan</span>
                fusionContribution <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>;
            }
	    <span style="color: #408080; font-style: italic">// add fusion rate contribution of these two particles total</span>
            fusionRateHere <span style="color: #666666">+=</span> fusionContribution;

            <span style="color: #408080; font-style: italic">// -------------------------------------------------</span>
            <span style="color: #408080; font-style: italic">// Calculate Coulomb collision scatttering angle</span>
            <span style="color: #408080; font-style: italic">// -------------------------------------------------</span>
            <span style="color: #408080; font-style: italic">// The &#39;(float(np)/float(npTrunc))&#39; is there to offset any &#39;under-colliding&#39;</span>
            <span style="color: #408080; font-style: italic">// that would be done if we aren&#39;t operating on all the particles</span>
            <span style="color: #B00040">float</span> N <span style="color: #666666">=</span> (((PIdt<span style="color: #666666">*</span>VDm)<span style="color: #666666">*</span>bmax[c]<span style="color: #666666">*</span>bmax[c])<span style="color: #666666">*</span>rho[c]) <span style="color: #666666">/</span> 
                         (CellVolumesPM[c]<span style="color: #666666">*</span>(L<span style="color: #666666">*</span>L<span style="color: #666666">*</span>L))<span style="color: #666666">*</span>(<span style="color: #B00040">float</span>(np)<span style="color: #666666">/</span><span style="color: #B00040">float</span>(npTrunc));  <span style="color: #408080; font-style: italic">// Eq. (2)</span>
            <span style="color: #408080; font-style: italic">// Above eqution divides by cell volume because our &quot;rho&quot; is </span>
            <span style="color: #408080; font-style: italic">// actually particles per cell, rather than particles per m^3</span>
            
            <span style="color: #408080; font-style: italic">// inverse of the magnitude of the relative velocity</span>
            <span style="color: #B00040">float</span> VRi <span style="color: #666666">=</span> VRm<span style="color: #666666">&gt;0</span> <span style="color: #666666">?</span> <span style="color: #666666">1.0f/</span>VRm <span style="color: #666666">:</span> <span style="color: #666666">0.0f</span>;
            
            <span style="color: #008000; font-weight: bold">if</span> (N <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>){
                <span style="color: #B00040">float</span> theta;
                <span style="color: #B00040">float</span> a <span style="color: #666666">=</span> a_coeff<span style="color: #666666">*</span>VD2i<span style="color: #666666">/</span>bmax[c]; <span style="color: #408080; font-style: italic">// Eq. (6)</span>
                <span style="color: #B00040">float</span> sTildeAsqoN <span style="color: #666666">=</span> (a<span style="color: #666666">*</span>sqrtf(N))<span style="color: #666666">*</span>(KS4 <span style="color: #666666">-</span> KS1<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>KS2<span style="color: #666666">*</span>powf(N,KS3))); <span style="color: #408080; font-style: italic">// Eq. (31a)</span>
                <span style="color: #B00040">float</span> s <span style="color: #666666">=</span> sTildeAsqoN<span style="color: #666666">*</span>pow((<span style="color: #666666">1.0f</span> <span style="color: #666666">+</span> pow((TWOOVERPI<span style="color: #666666">*</span>sTildeAsqoN),KS5)),(<span style="color: #666666">1.0f/</span>KS5)); <span style="color: #408080; font-style: italic">// Eq. (32a)</span>
                <span style="color: #408080; font-style: italic">// Create random variables U (for scattering angle theta) </span>
                <span style="color: #408080; font-style: italic">// and V (for azimuthal angle phi)</span>
                <span style="color: #B00040">float</span> U <span style="color: #666666">=</span> curand_uniform(<span style="color: #666666">&amp;</span>myCurandstate[c]);
                <span style="color: #B00040">float</span> V <span style="color: #666666">=</span> curand_uniform(<span style="color: #666666">&amp;</span>myCurandstate[c]);
                
                <span style="color: #008000; font-weight: bold">if</span>(s <span style="color: #666666">&gt;</span> PIOVERTWO<span style="color: #666666">-0.2f</span>){ 
                <span style="color: #408080; font-style: italic">// If s is close to pi/2, we are approximately isotropic.  this happens</span>
                <span style="color: #408080; font-style: italic">// when two particles are traveling close to the same speed</span>
                    theta <span style="color: #666666">=</span> acosf(<span style="color: #666666">1.9999f*</span>U<span style="color: #666666">-0.9998f</span>);  
                    <span style="color: #408080; font-style: italic">// use 1.9999 and 0.9998 instead of 2 and 1 to avoid the remote</span>
                    <span style="color: #408080; font-style: italic">// possibility of an argument equal to -1 or 1</span>
                }<span style="color: #008000; font-weight: bold">else</span>{
                    <span style="color: #408080; font-style: italic">// Eqs. (31b-31d)</span>
                    <span style="color: #B00040">float</span> kTilde <span style="color: #666666">=</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">-</span> KK1<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>KK2<span style="color: #666666">*</span>powf(N,KK3));
                    <span style="color: #B00040">float</span> lTilde <span style="color: #666666">=</span> KL1<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>KL2<span style="color: #666666">*</span>powf(N,KL3));
                    <span style="color: #B00040">float</span> hTilde <span style="color: #666666">=</span> KH1<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>KH2<span style="color: #666666">*</span>powf(N,KH3));
	            <span style="color: #408080; font-style: italic">// Eqs. (32b-32d)</span>
                    <span style="color: #B00040">float</span> k <span style="color: #666666">=</span> kTilde<span style="color: #666666">*</span>expf(KK4<span style="color: #666666">*</span>powf(s,KK5));
                    <span style="color: #B00040">float</span> l <span style="color: #666666">=</span> lTilde<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>KL4<span style="color: #666666">*</span>powf(s,KL5));
                    <span style="color: #B00040">float</span> h <span style="color: #666666">=</span> hTilde<span style="color: #666666">*</span>expf(<span style="color: #666666">-</span>KH4<span style="color: #666666">*</span>powf(s,KH5));
                    
                    <span style="color: #408080; font-style: italic">// if any of k, l, or h are greater than 1 or less than 0, set within these bounds</span>
                    k <span style="color: #666666">=</span> k <span style="color: #666666">&gt;</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">?</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">:</span> k;
                    k <span style="color: #666666">=</span> k <span style="color: #666666">&lt;</span> <span style="color: #666666">0.0f</span> <span style="color: #666666">?</span> <span style="color: #666666">0.0f</span> <span style="color: #666666">:</span> k;
                    l <span style="color: #666666">=</span> l <span style="color: #666666">&gt;</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">?</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">:</span> l;
                    l <span style="color: #666666">=</span> l <span style="color: #666666">&lt;</span> <span style="color: #666666">0.0f</span> <span style="color: #666666">?</span> <span style="color: #666666">0.0f</span> <span style="color: #666666">:</span> l;
                    h <span style="color: #666666">=</span> h <span style="color: #666666">&gt;</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">?</span> <span style="color: #666666">1.0f</span> <span style="color: #666666">:</span> h;
                    h <span style="color: #666666">=</span> h <span style="color: #666666">&lt;</span> <span style="color: #666666">0.0f</span> <span style="color: #666666">?</span> <span style="color: #666666">0.0f</span> <span style="color: #666666">:</span> h;
                    
                    <span style="color: #408080; font-style: italic">// Eq. (27) branching (see Fig. 3 in my Coulomb collision paper a graphical representation)</span>
                    <span style="color: #008000; font-weight: bold">if</span> (U <span style="color: #666666">&gt;=</span> h){ <span style="color: #408080; font-style: italic">// theta_transition or theta_low</span>
			<span style="color: #408080; font-style: italic">// Called &quot;varSigma&quot; because that is the name of the LaTeX character I used to represent it</span>
                        <span style="color: #B00040">float</span> varSigma <span style="color: #666666">=</span> cosf(s)<span style="color: #666666">/</span>(sinf(s)<span style="color: #666666">*</span>sinf(s)); <span style="color: #408080; font-style: italic">// Eq. (22)</span>
                        <span style="color: #B00040">float</span> invVarSigma <span style="color: #666666">=</span> <span style="color: #666666">1.0f/</span>varSigma;
                        <span style="color: #008000; font-weight: bold">if</span> (U <span style="color: #666666">&gt;=</span> l){ 
                            <span style="color: #408080; font-style: italic">// Most common route: theta_low</span>
                            <span style="color: #408080; font-style: italic">// (with extra &quot;abs&quot; to prevent negative number in logarithm,</span>
                            <span style="color: #408080; font-style: italic">// though U should never be low enough to reach that point)</span>
                            <span style="color: #408080; font-style: italic">// (u_low-1)/kappa + 1 &gt; 0, so: u_low &gt; 1-kappa </span>
                            theta <span style="color: #666666">=</span> <span style="color: #408080; font-style: italic">// three different expressions to prevent </span>
                                    (varSigma<span style="color: #666666">&gt;1.0e6</span>f)
                                    <span style="color: #666666">?</span>
                                        <span style="color: #408080; font-style: italic">// Taylor expansion of acos(1-x) at x=0 is sqrt(2*x).  we need this taylor </span>
                                        <span style="color: #408080; font-style: italic">// expansion when varSigma &gt; 1e6 or so, because evaluating 1+1e-8</span>
                                        <span style="color: #408080; font-style: italic">// in single results in 1</span>
                                        sqrtf(<span style="color: #666666">-2*</span>invVarSigma<span style="color: #666666">*</span>logf(fabsf((U<span style="color: #666666">-1.0f</span>)<span style="color: #666666">/</span>k<span style="color: #666666">+1.0f</span>))) 
                                        <span style="color: #666666">:</span>
                                        (
                                            (varSigma<span style="color: #666666">&gt;80.0f</span>)
                                            <span style="color: #666666">?</span>
                                            (acosf(<span style="color: #666666">1.0f</span> <span style="color: #666666">+</span> invVarSigma<span style="color: #666666">*</span>logf(fabsf((U<span style="color: #666666">-1.0f</span>)<span style="color: #666666">/</span>k<span style="color: #666666">+1.0f</span>)))) <span style="color: #408080; font-style: italic">// eq. (25)</span>
                                            <span style="color: #666666">:</span>
                                            (acosf(invVarSigma<span style="color: #666666">*</span>logf(fabsf(expf(<span style="color: #666666">-</span>varSigma)
                                                <span style="color: #666666">+</span> <span style="color: #666666">2.0f*</span>sinhf(varSigma)<span style="color: #666666">*</span>((U<span style="color: #666666">-1.0f</span>)<span style="color: #666666">/</span>k<span style="color: #666666">+1.0f</span>))))) <span style="color: #408080; font-style: italic">// eq. (24)</span>
                                         )
                                    ;
                        }<span style="color: #008000; font-weight: bold">else</span>{ <span style="color: #408080; font-style: italic">// second-most common route: theta_mid</span>
                            <span style="color: #408080; font-style: italic">// to evaluate, we need expressions similar to theta_low (above) and theta_high (below)</span>
                            <span style="color: #B00040">float</span> thetaHighUhigh <span style="color: #666666">=</span> <span style="color: #666666">2.0f*</span>atanf(a<span style="color: #666666">*</span>sqrtf(N<span style="color: #666666">/</span>h));
                     
                            <span style="color: #B00040">float</span> thetaLowUlow <span style="color: #666666">=</span> 
                                    (varSigma<span style="color: #666666">&gt;1.0e6</span>f)
                                    <span style="color: #666666">?</span>
                                        sqrtf(<span style="color: #666666">-2*</span>invVarSigma<span style="color: #666666">*</span>logf(fabsf((l<span style="color: #666666">-1.0f</span>)<span style="color: #666666">/</span>k<span style="color: #666666">+1.0f</span>)))
                                        <span style="color: #666666">:</span>
                                        (
                                            (varSigma<span style="color: #666666">&gt;80.0f</span>)
                                            <span style="color: #666666">?</span>
                                            (acosf(<span style="color: #666666">1.0f</span> <span style="color: #666666">+</span> invVarSigma<span style="color: #666666">*</span>logf(fabsf((l<span style="color: #666666">-1.0f</span>)<span style="color: #666666">/</span>k<span style="color: #666666">+1.0f</span>))))  <span style="color: #408080; font-style: italic">// eq. (25)</span>
                                            <span style="color: #666666">:</span>
                                            (acosf(invVarSigma<span style="color: #666666">*</span>logf(fabsf(expf(<span style="color: #666666">-</span>varSigma)
                                                <span style="color: #666666">+</span> <span style="color: #666666">2.0f*</span>sinhf(varSigma)<span style="color: #666666">*</span>((l<span style="color: #666666">-1.0f</span>)<span style="color: #666666">/</span>k<span style="color: #666666">+1.0f</span>))))) <span style="color: #408080; font-style: italic">// eq. (24)</span>
                                         )
                                    ;

                            theta <span style="color: #666666">=</span> thetaLowUlow<span style="color: #666666">*</span>powf((U<span style="color: #666666">/</span>l), (logf(thetaLowUlow<span style="color: #666666">/</span>thetaHighUhigh)<span style="color: #666666">/</span>logf(l<span style="color: #666666">/</span>h)));
                            <span style="color: #408080; font-style: italic">// Eq. (26)</span>
                        }
                    }<span style="color: #008000; font-weight: bold">else</span>{ <span style="color: #408080; font-style: italic">// least common route: theta_high</span>
                        theta <span style="color: #666666">=</span> <span style="color: #666666">2.0f*</span>atanf(a<span style="color: #666666">*</span>sqrtf(N<span style="color: #666666">/</span>U)); <span style="color: #408080; font-style: italic">// eq. (21)</span>
                    }
                }

                <span style="color: #408080; font-style: italic">// -------------------------------------------------</span>
                <span style="color: #408080; font-style: italic">// Perform Collision</span>
                <span style="color: #408080; font-style: italic">// -------------------------------------------------</span>

                <span style="color: #408080; font-style: italic">// rel velocity normalized to a unit vector</span>
                <span style="color: #B00040">float</span> VRNx <span style="color: #666666">=</span> VRx<span style="color: #666666">*</span>VRi;
                <span style="color: #B00040">float</span> VRNr <span style="color: #666666">=</span> VRr<span style="color: #666666">*</span>VRi;
                <span style="color: #B00040">float</span> VRNt <span style="color: #666666">=</span> VRt<span style="color: #666666">*</span>VRi;
                <span style="color: #408080; font-style: italic">// collision scattering angle</span>
                <span style="color: #B00040">float</span> sinTheta <span style="color: #666666">=</span> sinf(theta);
                <span style="color: #B00040">float</span> cosTheta <span style="color: #666666">=</span> cosf(theta);
                <span style="color: #408080; font-style: italic">// azimuthal angle of collision</span>
                <span style="color: #B00040">float</span> phi <span style="color: #666666">=</span> TWOPI<span style="color: #666666">*</span>V; <span style="color: #408080; font-style: italic">// random between 0 and 2*pi</span>
                <span style="color: #B00040">float</span> sinPhi <span style="color: #666666">=</span> sinf(phi);
                <span style="color: #B00040">float</span> cosPhi <span style="color: #666666">=</span> cosf(phi);
                <span style="color: #408080; font-style: italic">// create vector &quot;R&quot; perpendicular to v_rel_com_norm</span>
                <span style="color: #B00040">float</span> Rx, Rr, Rt;
                <span style="color: #008000; font-weight: bold">if</span> (VRNr<span style="color: #666666">!=1.0f</span>){
                    Rx <span style="color: #666666">=</span> <span style="color: #666666">-</span>VRNt;
                    Rr <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>;
                    Rt <span style="color: #666666">=</span> VRNx;
                }<span style="color: #008000; font-weight: bold">else</span>{ <span style="color: #408080; font-style: italic">// avoids the very very unlikely possibility of getting the zero vector</span>
                    Rx <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>;
                    Rr <span style="color: #666666">=</span> VRNr;
                    Rt <span style="color: #666666">=</span> <span style="color: #666666">-</span>VRNt;
                }
                <span style="color: #408080; font-style: italic">// vector &quot;U&quot; = VRN cross R</span>
                <span style="color: #B00040">float</span> Ux <span style="color: #666666">=</span> VRNr<span style="color: #666666">*</span>Rt <span style="color: #666666">-</span> VRNt<span style="color: #666666">*</span>Rr;
                <span style="color: #B00040">float</span> Ur <span style="color: #666666">=</span> VRNt<span style="color: #666666">*</span>Rx <span style="color: #666666">-</span> VRNx<span style="color: #666666">*</span>Rt;
                <span style="color: #B00040">float</span> Ut <span style="color: #666666">=</span> VRNx<span style="color: #666666">*</span>Rr <span style="color: #666666">-</span> VRNr<span style="color: #666666">*</span>Rx;
                <span style="color: #408080; font-style: italic">// vector &quot;P&quot; = U*sin(phi) + R*cos(phi)</span>
                <span style="color: #B00040">float</span> Px <span style="color: #666666">=</span> Ux<span style="color: #666666">*</span>sinPhi <span style="color: #666666">+</span> Rx<span style="color: #666666">*</span>cosPhi;
                <span style="color: #B00040">float</span> Pr <span style="color: #666666">=</span> Ur<span style="color: #666666">*</span>sinPhi <span style="color: #666666">+</span> Rr<span style="color: #666666">*</span>cosPhi;
                <span style="color: #B00040">float</span> Pt <span style="color: #666666">=</span> Ut<span style="color: #666666">*</span>sinPhi <span style="color: #666666">+</span> Rt<span style="color: #666666">*</span>cosPhi;
                <span style="color: #408080; font-style: italic">// Normalize P</span>
                <span style="color: #B00040">float</span> P2 <span style="color: #666666">=</span> Px<span style="color: #666666">*</span>Px <span style="color: #666666">+</span> Pr<span style="color: #666666">*</span>Pr <span style="color: #666666">+</span> Pt<span style="color: #666666">*</span>Pt;
                <span style="color: #B00040">float</span> Pi <span style="color: #666666">=</span> P2<span style="color: #666666">&gt;0.0f</span> <span style="color: #666666">?</span> rsqrtf(P2) <span style="color: #666666">:</span> <span style="color: #666666">0.0f</span>; <span style="color: #408080; font-style: italic">// check for zero</span>
                Px <span style="color: #666666">*=</span> Pi;
                Pr <span style="color: #666666">*=</span> Pi;
                Pt <span style="color: #666666">*=</span> Pi;
                <span style="color: #408080; font-style: italic">// Vector &quot;T&quot; is the unnormalized rel velocity rotated towards &quot;P&quot; by theta,</span>
                <span style="color: #408080; font-style: italic">// this is the new velocity of p1 in the COM frame</span>
                <span style="color: #B00040">float</span> Tx <span style="color: #666666">=</span> VRx<span style="color: #666666">*</span>cosTheta <span style="color: #666666">+</span> (Pr<span style="color: #666666">*</span>VRt <span style="color: #666666">-</span> Pt<span style="color: #666666">*</span>VRr)<span style="color: #666666">*</span>sinTheta;
                <span style="color: #B00040">float</span> Tr <span style="color: #666666">=</span> VRr<span style="color: #666666">*</span>cosTheta <span style="color: #666666">+</span> (Pt<span style="color: #666666">*</span>VRx <span style="color: #666666">-</span> Px<span style="color: #666666">*</span>VRt)<span style="color: #666666">*</span>sinTheta;
                <span style="color: #B00040">float</span> Tt <span style="color: #666666">=</span> VRt<span style="color: #666666">*</span>cosTheta <span style="color: #666666">+</span> (Px<span style="color: #666666">*</span>VRr <span style="color: #666666">-</span> Pr<span style="color: #666666">*</span>VRx)<span style="color: #666666">*</span>sinTheta;
                <span style="color: #408080; font-style: italic">// Vector &quot;C&quot; is the change in velocity in the lab frame</span>
                <span style="color: #B00040">float</span> Cx <span style="color: #666666">=</span> Tx <span style="color: #666666">-</span> VRx;
                <span style="color: #B00040">float</span> Cr <span style="color: #666666">=</span> Tr <span style="color: #666666">-</span> VRr;
                <span style="color: #B00040">float</span> Ct <span style="color: #666666">=</span> Tt <span style="color: #666666">-</span> VRt;
                <span style="color: #408080; font-style: italic">// Check for NaN&#39;s and zero them out if necessary</span>
                <span style="color: #008000; font-weight: bold">if</span> (Cx<span style="color: #666666">!=</span>Cx)
                    Cx <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>;
                <span style="color: #008000; font-weight: bold">if</span> (Cr<span style="color: #666666">!=</span>Cr)
                    Cr <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>;
                <span style="color: #008000; font-weight: bold">if</span> (Ct<span style="color: #666666">!=</span>Ct)
                    Ct <span style="color: #666666">=</span> <span style="color: #666666">0.0f</span>;
                <span style="color: #408080; font-style: italic">// apply collision velocity change to particles</span>
                vx[p1] <span style="color: #666666">+=</span> Cx;
                vr[p1] <span style="color: #666666">+=</span> Cr;
                vt[p1] <span style="color: #666666">+=</span> Ct;
                vx[p2] <span style="color: #666666">-=</span> Cx;
                vr[p2] <span style="color: #666666">-=</span> Cr;
                vt[p2] <span style="color: #666666">-=</span> Ct;
            }
        }
        fusionRate[c] <span style="color: #666666">=</span> fusionRateHere; <span style="color: #408080; font-style: italic">// record fusion rate in this cell</span>
        c <span style="color: #666666">+=</span> <span style="color: #008000">blockDim</span>.x<span style="color: #666666">*</span><span style="color: #008000">gridDim</span>.x;      <span style="color: #408080; font-style: italic">// go to next cell assigned to this process</span>
    }
}
</pre></td></tr></table></div>

